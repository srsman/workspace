{
    "contents" : "## if we want to change the stock pick ,we just need to update the \"hs300all\"\nportfolio_construct=function(mylist,select_industry,start_time=\"2005-01-01\",period=124,bili=0.5) {\n  final_stock_pick=list();\n  \n  hs300all=read.csv(\"hs300index.csv\");##读取每个交易日hs300成分股的代码以及权重\n  hs300all[,\"Date\"]=as.Date(hs300all[,\"Date\"])\n  hs300date=unique(hs300all[,\"Date\"])\n  hs300date=as.character(hs300date);\n  hs300date=as.Date(hs300date)\n  date=seq(as.Date(start_time), length=period, by=\"month\");\n  date=as.Date(date)\n  for (i in 1:length(date)) {\n      thisdate=date[i];\n      ##select hs300 stock in date[i]\n     thishs300date=max(hs300date[hs300date<=thisdate],na.rm=F)\n     if (thishs300date==-Inf) { thishs300date=\"2005-04-08\" }\n    thishs300= hs300all[which(hs300all$Date==thishs300date),]\n    thishs300=thishs300[,c(2,4)]\n    colnames(thishs300)=c(\"trade_code\",\"weight_hs300\")\n    thishs300[,\"weight_hs300\"]= thishs300[,\"weight_hs300\"]/sum( thishs300[,\"weight_hs300\"])\n    \n    ###select allA in date[i]\n    thisallA=mylist[[i]]\n    \n    \n    ##select industry in date[i]\n    thismonth=as.POSIXlt(thisdate)$mon+1\n    thisindustry=select_industry[which(select_industry$month==thismonth),]\n    thisindustry=thisindustry[,\"industry\"]\n    thisindustry=as.data.frame(thisindustry)\n    colnames(thisindustry)=\"industry\";\n    \n    ###select hs300's stock in selected industry by month effect\n    thisstock_month=merge(thisindustry,thisallA,by=\"industry\")\n    thisstock_month=merge(thishs300,thisstock_month,by=\"trade_code\")\n    \n    ##select stock  with month and amt effect;\n    before_sort_data=thisstock_month\n    after_sort_data=before_sort_data[order(before_sort_data[,\"avg_amt\"]),];\n    after_sort_data=after_sort_data[is.na(after_sort_data[,\"avg_amt\"])!=1,];\n    a=dim(after_sort_data)[1];\n    a1=a*bili;\n    a1=floor(a1);\n    select_sort_data1=after_sort_data[1:a1,];  ###selected trade_code in i_th month\n    thisstock_month_amt=as.data.frame(select_sort_data1);\n    \n    ##caculate the weight \n    linshi=thisstock_month_amt\n    industry_weight=aggregate(x=linshi$weight_hs300,by=list(linshi$industry),FUN=sum) \n    colnames(industry_weight)=c(\"industry\",\"weight_industry\")\n    industry_weight[,\"weight_industry\"]= industry_weight[,\"weight_industry\"]/sum(industry_weight[,\"weight_industry\"])\n    linshi=merge(linshi,industry_weight,by=\"industry\")\n    \n    industry_mkt=aggregate(x=linshi$avg_mkt,by=list(linshi$industry),FUN=sum) \n    colnames(industry_mkt)=c(\"industry\",\"mkt_industry\")\n    linshi=merge(linshi,industry_mkt,by=\"industry\")\n    linshi[,\"weight_mkt\"]=linshi[,\"avg_mkt\"]/linshi[,\"mkt_industry\"]\n    \n    linshi[,\"weight\"]=linshi[,\"weight_industry\"]*linshi[,\"weight_mkt\"]\n    \n    thisstock_month_amt=linshi[,c(\"trade_code\",\"weight\")]\n\n    final_stock_pick[[i]]=thisstock_month_amt;\n   \n  }\n  trade_day=sqlQuery(ch,'select distinct datetime from dailyprice')[,1]\n  trade_day=as.Date(trade_day)\n  trad=NULL;\n  for ( i in date){\n    a=max(trade_day[trade_day<i])\n   trad<-c(trad,a)\n }\n trad=as.Date(trad,origin=\"1970-01-01\")\n trad=as.character(trad)\n  names(final_stock_pick)=trad;\n  return(final_stock_pick);\n}\n\n\n",
    "created" : 1429601795534.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4005153144",
    "id" : "ED80575A",
    "lastKnownWriteTime" : 1429072577,
    "path" : "D:/zdqh/月份效应/Part2 portfolio_construct.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}